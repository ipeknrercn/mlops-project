name: CI/CD Pipeline - Telco Churn MLOps

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_IMAGE_TRAIN: churn-train
  DOCKER_IMAGE_API: churn-api
  PYTHON_VERSION: '3.10'

jobs:
  # ==========================================
  # STAGE 1: CODE QUALITY & LINTING
  # ==========================================
  lint:
    name: üîç Code Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install linting tools
      run: |
        pip install pylint flake8
        pip install -r requirements.txt
    
    - name: Run Pylint
      run: |
        echo "üîç Running Pylint with threshold 7.0..."
        pylint scripts/ api/ --fail-under=7.0
    
    - name: Run Flake8
      run: |
        echo "üîç Running Flake8..."
        flake8 scripts/ api/

  # ==========================================
  # STAGE 2: UNIT TESTING
  # ==========================================
  unit-test:
    name: üß™ Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Run Unit Tests
      run: |
        echo "üß™ Running Unit Tests..."
        pytest tests/test_feature_engineering.py -v --tb=short
    
    - name: Generate Coverage Report
      run: |
        pytest tests/test_feature_engineering.py --cov=scripts --cov-report=term

  # ==========================================
  # STAGE 3: BUILD DOCKER IMAGES
  # ==========================================
  build:
    name: üê≥ Build Docker Images
    runs-on: ubuntu-latest
    needs: unit-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Training Container
      run: |
        echo "üê≥ Building Training Docker Image..."
        docker build -t ${{ env.DOCKER_IMAGE_TRAIN }}:${{ github.sha }} .
        docker tag ${{ env.DOCKER_IMAGE_TRAIN }}:${{ github.sha }} ${{ env.DOCKER_IMAGE_TRAIN }}:latest
    
    - name: Build API Container
      run: |
        echo "üê≥ Building API Docker Image..."
        docker build -t ${{ env.DOCKER_IMAGE_API }}:${{ github.sha }} -f api/Dockerfile .
        docker tag ${{ env.DOCKER_IMAGE_API }}:${{ github.sha }} ${{ env.DOCKER_IMAGE_API }}:latest
    
    - name: Verify Images Built
      run: |
        docker images | grep churn

  # ==========================================
  # STAGE 4: SMOKE TEST (DEPLOYMENT VERIFICATION)
  # ==========================================
  smoke-test:
    name: üî• Smoke Test
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Build API Container
      run: |
        docker build -t ${{ env.DOCKER_IMAGE_API }}:latest -f api/Dockerfile .
    
    - name: Start API Container
      run: |
        echo "üöÄ Starting API container..."
        docker run -d -p 8000:8000 --name api-test ${{ env.DOCKER_IMAGE_API }}:latest
        sleep 10
    
    - name: Install test dependencies
      run: |
        pip install requests
    
    - name: Run Smoke Test
      run: |
        echo "üî• Running Smoke Test..."
        python tests/smoke_test.py
    
    - name: Show container logs (if failed)
      if: failure()
      run: |
        docker logs api-test
    
    - name: Cleanup
      if: always()
      run: |
        docker stop api-test || true
        docker rm api-test || true

  # ==========================================
  # STAGE 5: DEPLOYMENT GATE
  # ==========================================
  deploy:
    name: üöÄ Deploy
    runs-on: ubuntu-latest
    needs: smoke-test
    
    steps:
    - name: Deployment Successful
      run: |
        echo "============================================"
        echo "‚úÖ ALL STAGES PASSED - READY TO DEPLOY"
        echo "============================================"
        echo "üì¶ Artifacts built and tested successfully"
        echo "üéØ Pipeline Status: GREEN"
        echo "============================================"